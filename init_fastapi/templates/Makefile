.PHONY: help build push build-push up down restart logs clean test

IMAGE_NAME := uhub.service.ucloud.cn/vst_repository/${project_name}
VERSION ?= latest

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Sign Vision API - Docker ç®¡ç†å‘½ä»¤"
	@echo ""
	@echo "ä½¿ç”¨æ–¹æ³•: make [å‘½ä»¤]"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-15s %s\n", $$1, $$2}'

build: ## æ„å»º Docker é•œåƒ
	@echo "ğŸ”¨ æ„å»ºé•œåƒ: $(IMAGE_NAME):$(VERSION)"
	docker build -t $(IMAGE_NAME):$(VERSION) .
	@if [ "$(VERSION)" != "latest" ]; then \
		docker tag $(IMAGE_NAME):$(VERSION) $(IMAGE_NAME):latest; \
	fi
	@echo "âœ… æ„å»ºå®Œæˆ"

push: ## æ¨é€é•œåƒåˆ° UCloud
	@echo "ğŸ“¤ æ¨é€é•œåƒ: $(IMAGE_NAME):$(VERSION)"
	docker push $(IMAGE_NAME):$(VERSION)
	@if [ "$(VERSION)" != "latest" ]; then \
		docker push $(IMAGE_NAME):latest; \
	fi
	@echo "âœ… æ¨é€å®Œæˆ"

build-push: build push ## æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆä¸€é”®æ“ä½œï¼‰
	@echo "ğŸ‰ æ„å»ºå¹¶æ¨é€å®Œæˆï¼"

pull: ## ä» UCloud æ‹‰å–é•œåƒ
	@echo "ğŸ“¥ æ‹‰å–é•œåƒ: $(IMAGE_NAME):$(VERSION)"
	docker pull $(IMAGE_NAME):$(VERSION)
	@echo "âœ… æ‹‰å–å®Œæˆ"

up: ## å¯åŠ¨æœåŠ¡ï¼ˆdocker-composeï¼‰
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
	docker-compose up -d
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨"
	@echo "ğŸ“ API: http://localhost:8000"
	@echo "ğŸ“ æ–‡æ¡£: http://localhost:8000/docs"

down: ## åœæ­¢æœåŠ¡
	@echo "ğŸ›‘ åœæ­¢æœåŠ¡..."
	docker-compose down
	@echo "âœ… æœåŠ¡å·²åœæ­¢"

restart: ## é‡å¯æœåŠ¡
	@echo "ğŸ”„ é‡å¯æœåŠ¡..."
	docker-compose restart
	@echo "âœ… æœåŠ¡å·²é‡å¯"

logs: ## æŸ¥çœ‹æ—¥å¿—
	docker-compose logs -f

clean: ## æ¸…ç†æœªä½¿ç”¨çš„ Docker èµ„æº
	@echo "ğŸ§¹ æ¸…ç† Docker èµ„æº..."
	docker system prune -f
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-all: ## æ¸…ç†æ‰€æœ‰ Docker èµ„æºï¼ˆåŒ…æ‹¬é•œåƒï¼‰
	@echo "âš ï¸  æ¸…ç†æ‰€æœ‰ Docker èµ„æº..."
	docker system prune -a -f
	@echo "âœ… æ¸…ç†å®Œæˆ"

shell: ## è¿›å…¥å®¹å™¨ Shell
	docker exec -it sign-vision-api /bin/bash

login: ## ç™»å½• UCloud å®¹å™¨é•œåƒä»“åº“
	@echo "ğŸ” ç™»å½• UCloud å®¹å™¨é•œåƒä»“åº“..."
	docker login uhub.service.ucloud.cn

dev: ## å¼€å‘æ¨¡å¼ï¼ˆå¸¦å·æŒ‚è½½ï¼‰
	@echo "ğŸ”§ å¯åŠ¨å¼€å‘æ¨¡å¼..."
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

deploy: build push ## æ„å»ºå¹¶æ¨é€ï¼ˆå®Œæ•´å‘å¸ƒæµç¨‹ï¼‰
	@echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
	@echo "åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ: docker pull $(IMAGE_NAME):$(VERSION) && docker-compose up -d"


